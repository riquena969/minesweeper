<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <style>
        body {
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        h1 {
            text-transform: uppercase;
            line-height: 50px
        }

        #board {
            border: 2px dotted #555;
            width: auto;
            display: inline-block;
        }

        #movementType {
            background-image: url("./img/square-green.png");
            background-size: 100% 100%;
            display: inline-block;
            width: 50px;
            height: 50px;
        }

        .square {
            background-image: url('./img/square.png');
            background-size: 100% 100%;
            display: inline-block;
            width: 50px;
            height: 50px;
            margin: 2px;
            line-height: 50px;
            text-align: center;
            font-weight: bolder;
        }
    </style>
</head>
<body>
    <h1>
        <div id="movementType" onclick="changeMovement()" title="Click to change the type of movement. Hint: Press ctrl to change movement temporary"></div>
        Minesweeper
    </h1>
    <div><small>Bombs number: <span id="bombsNumber">0</span></small></div>
    <div id="board"></div>
    <script>
        var width;
        var height;
        var bombsNumberTotal;
        var bombsNumber;
        var bombMaps;
        var difficulty;
        var mark;

        desenharQuadro();

        function desenharQuadro() {
            this.width            = 12;
            this.height           = 8;
            this.bombsNumber      = 0;
            this.bombMaps         = [];
            this.difficulty       = 7;
            this.mark             = true;

            for (var i = 0; i < height; i++) {
                bombMaps[i] = [];
                for (var j = 0; j < width; j++) {
                    bombMaps[i][j] = Math.floor((Math.random() * 100/difficulty)) == 0;
                    bombsNumber += bombMaps[i][j] ? 1 : 0;
                    document.getElementById('board').innerHTML += `<div id="square_${ i }_${ j }" class="square" onclick="selectItem(${ i }, ${ j }, true, event)">&nbsp;</div>`;
                }
                document.getElementById('board').innerHTML += '<br>';
            }
            bombsNumberTotal = bombsNumber;
            document.getElementById('bombsNumber').innerHTML = bombsNumber + ' of ' + bombsNumberTotal;
        }

        function selectItem(column, row, allowRecursion, event) {
            if (event && event.ctrlKey) {
                mark = !mark;
            }
            if (mark) {
                if (document.getElementById(`square_${ column }_${ row }`).marked != '1') {
                    if (bombMaps[column][row]) {
                        document.getElementById(`square_${ column }_${ row }`).style.backgroundImage = 'url("./img/explosion.png")';
                        if (allowRecursion) {
                            changeItensToRed();
                            for (var i = 0; i < height; i++) {
                                for (var j = 0; j < width; j++) {
                                    selectItem(i, j, false);
                                }
                            }
                        }
                    } else {
                        var bombsNumberLaterais = getbombsNumberLaterais(column, row);

                        if (bombsNumberLaterais == 0 && allowRecursion) {
                            for (var i = -1; i < 2; i++) {
                                for (var j = -1; j < 2; j++) {
                                    if ((column + i >= 0) && (row + j >= 0) && (column + i < height) && (row + j < width)) {
                                        selectItem(column + i, row + j, false);
                                    }
                                }
                            }
                        }

                        if (bombsNumberLaterais > 0) {
                            document.getElementById(`square_${ column }_${ row }`).innerHTML = bombsNumberLaterais;
                        }
                        document.getElementById(`square_${ column }_${ row }`).style.backgroundImage = 'url("./img/square-green.png")';
                    }
                }
            } else {
                if (document.getElementById(`square_${ column }_${ row }`).marked == '1') {
                    bombsNumber++;
                    document.getElementById(`square_${ column }_${ row }`).marked = '0';
                    document.getElementById(`square_${ column }_${ row }`).style.backgroundImage = 'url("./img/square.png")';
                } else {
                    bombsNumber--;
                    document.getElementById(`square_${ column }_${ row }`).marked = '1';
                    document.getElementById(`square_${ column }_${ row }`).style.backgroundImage = 'url("./img/square-yellow.png")';
                }
                document.getElementById('bombsNumber').innerHTML = bombsNumber + ' of ' + bombsNumberTotal;
            }
            if (event && event.ctrlKey) {
                mark = !mark;
            }
        }

        function getbombsNumberLaterais(column, row) {
            var bombsNumberLaterais = 0;

            for (var i = -1; i < 2; i++) {
                for (var j = -1; j < 2; j++) {
                    if ((column + i >= 0) && (row + j >= 0) && (column + i < height) && (row + j < width)) {
                        if (bombMaps[column + i][row + j]) {
                            bombsNumberLaterais++;
                        }
                    }
                }
            }

            return bombsNumberLaterais;
        }

        function changeMovement() {
            mark = !mark;
            document.getElementById('movementType').style.backgroundImage = 'url("./img/square-' + (mark ? 'green' : 'yellow') + '.png")';
        }

        function changeItensToRed() {
            for (var i = 0; i < height; i++) {
                for (var j = 0; j < width; j++) {
                    if (document.getElementById(`square_${ i }_${ j }`).marked == '1' && !bombMaps[i][j]) {
                        document.getElementById(`square_${ i }_${ j }`).style.backgroundImage = 'url("./img/square-red.png")';
                    }
                }
            }
        }
    </script>
</body>
</html>